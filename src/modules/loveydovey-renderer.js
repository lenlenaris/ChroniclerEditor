// ÂçøÂçøÊàëÊàëÂ∞àÁî®Ê∏≤ÊüìÂô®
class LoveyDoveyRenderer {
    
    // ‰∏ªË¶ÅÁâàÊú¨ÂÖßÂÆπÊ∏≤Êüì
static renderVersionContent(character, version) {
    return `
        <div class="version-content loveydovey-mode">
            <!--  Â§ñÂ±§ÂÆπÂô®Â¢ûÂä†ÈÇäË∑ù -->
            <div class="loveydovey-content-section" style="width: 95%; margin: 0 auto;">
                <div class="field-sections">
                    
                   <!-- Á¨¨‰∏ÄÂ§ßÂçÄÔºöÂÄã‰∫∫Ë≥áÊñôÔºàÂèØÊäòÁñäÔºâ -->
<div class="field-section collapsible-section" data-section="personal-profile" style="margin-top: -10px;">
    <div class="section-header collapsible-header ld-section-header" onclick="LoveyDoveyRenderer.toggleSection('personal-profile', event)">
                            <span class="collapse-icon">
                                <span class="arrow-icon arrow-down" style="width: 8px; height: 8px; color: var(--accent-color);"></span>
                            </span>
                            <h3 style="margin: 0; font-size: 1.1em; font-weight: 600; color: var(--text-color);">
                                ${t('profileSection')}
                            </h3>
                        </div>
                        <div class="section-content collapsible-content">
                            ${this.renderPersonalProfileFields(character, version)}
                        </div>
                    </div>
                    
                    <!-- Á¨¨‰∫åÂ§ßÂçÄÔºöËßíËâ≤Âü∫Êú¨Ë®≠ÂÆöÔºàÂèØÊäòÁñäÔºâ -->
                    <div class="field-section collapsible-section" data-section="basic-settings">
                        <div class="section-header collapsible-header ld-section-header" onclick="LoveyDoveyRenderer.toggleSection('basic-settings', event)">
                            <span class="collapse-icon">
                                <span class="arrow-icon arrow-down" style="width: 8px; height: 8px; color: var(--accent-color);"></span>
                            </span>
                            <h3 style="margin: 0; font-size: 1.1em; font-weight: 600; color: var(--text-color);">
                                ${t('basicSettingsSection')}
                            </h3>
                        </div>
                        <div class="section-content collapsible-content">
                            ${this.renderBasicSettingsFields(character, version)}
                        </div>
                    </div>
                    
                    <!-- Á¨¨‰∏âÂ§ßÂçÄÔºöÁ¨¨‰∏ÄÊ¨°ËÅäÂ§©Â†¥ÊôØÔºàÂèØÊäòÁñäÔºâ -->
                    <div class="field-section collapsible-section" data-section="first-chat">
                            <div class="section-header collapsible-header ld-section-header"
                                onclick="LoveyDoveyRenderer.toggleSection('first-chat', event)">
                                <span class="collapse-icon">
                                <span class="arrow-icon arrow-down" style="width: 8px; height: 8px; color: var(--accent-color);"></span>
                                </span>
                                <h3 style="margin: 0; font-size: 1.1em; font-weight: 600; color: var(--text-color);">
                                ${t('firstChatScenario')}
                                </h3>
                        </div>
                        <div class="section-content collapsible-content">
                            ${this.renderFirstChatFields(character, version)}
                        </div>
                    </div>
                    
                    <!-- Á¨¨ÂõõÂ§ßÂçÄÔºöËßíËâ≤Ë©≥Á¥∞Ë®≠ÂÆöÔºàÂèØÊäòÁñäÔºâ -->
                    <div class="field-section collapsible-section" data-section="detailed-settings">
                        <div class="section-header collapsible-header ld-section-header" onclick="LoveyDoveyRenderer.toggleSection('detailed-settings', event)">
                            <span class="collapse-icon">
                                <span class="arrow-icon arrow-down" style="width: 8px; height: 8px; color: var(--accent-color);"></span>
                            </span>
                            <h3 style="margin: 0; font-size: 1.1em; font-weight: 600; color: var(--text-color);">
                                ${t('detailedSettings')}
                            </h3>
                        </div>
                        <div class="section-content collapsible-content">
                            ${this.renderDetailedSettingsFields(character, version)}
                        </div>
                    </div>
                    
                    <!-- Á¨¨‰∫îÂ§ßÂçÄÔºöÂâµ‰ΩúËÄÖ‰∫ã‰ª∂ÔºàÂèØÊäòÁñäÔºâ -->
                    <div class="field-section collapsible-section" data-section="creator-events">
                        <div class="section-header collapsible-header ld-section-header" onclick="LoveyDoveyRenderer.toggleSection('creator-events', event)">
                            <span class="collapse-icon">
                                <span class="arrow-icon arrow-down" style="width: 8px; height: 8px; color: var(--accent-color);"></span>
                            </span>
                            <h3 style="margin: 0; font-size: 1.1em; font-weight: 600; color: var(--text-color);">
                                ${t('creatorEvents')}
                            </h3>
                        </div>
                        <div class="section-content collapsible-content">
                            ${this.renderCreatorEventsFields(character, version)}
                        </div>
                    </div>
                    
                </div>
            </div>
        </div>
    `;
}



     static renderPersonalProfileFields(character, version) {
    return `
        <!-- üìå Á¨¨‰∏ÄÂçÄÔºöÈ†≠ÂÉè + Âü∫Êú¨Ë≥áË®äÊ©´ÂêëÊéíÂàó -->
        <div style="display: flex; gap: 24px; align-items: flex-start; margin-bottom: var(--spacing-lg); flex-wrap: wrap;">
            <!-- È†≠ÂÉè -->
            <div class="avatar-section">
                <div class="avatar-preview loveydovey-avatar ${version.profileImage ? '' : 'avatar-upload-placeholder'}" 
                     onclick="triggerLoveyDoveyImageUpload('${character.id}', '${version.id}')"
                     style="
                         ${version.profileImage ? 'border: 1px solid var(--border-color);' : 'border: 2px dashed var(--border-color);'}
                     "
                     onmouseover="this.style.opacity='0.8'${version.profileImage ? '; this.style.transform=\'scale(1.02)\'' : '; this.style.borderColor=\'var(--primary-color)\''}"
                     onmouseout="this.style.opacity='1'${version.profileImage ? '; this.style.transform=\'scale(1)\'' : '; this.style.borderColor=\'var(--border-color)\''}">
                    ${version.profileImage ? 
                        `<img src="${BlobManager.getBlobUrl(version.profileImage)}" alt="Profile">` : 
                        `<div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: var(--text-muted); font-size: 0.9em; text-align: center;">
                            <div>
                                <div style="color: var(--text-muted); font-size: 3em; margin-bottom: 12px;">+</div>
                                ${t('clickToUpload')}
                            </div>
                        </div>`
                    }
                </div>
                <input type="file" class="file-input" id="profileImage-upload-${version.id}" accept="image/*" 
                       onchange="handleLoveyDoveyImageUpload('${character.id}', '${version.id}', this.files[0])">
            </div>

            <!-- Âü∫Êú¨Ê¨Ñ‰Ωç -->
            <div style="flex: 1; display: flex; flex-direction: column; gap: 3px;">
                ${LoveyDoveyRenderer.createLoveyDoveyField({
                    id: `characterName-${version.id}`,
                    label: t('characterName'),
                    placeholder: t('characterNamePlaceholder'),
                    value: version.characterName || '',
                    itemType: 'loveydovey',
                    itemId: character.id,
                    versionId: version.id,
                    fieldName: 'characterName',
                    isTextarea: false,
                    maxLength: 15
                })}
                ${LoveyDoveyRenderer.createLoveyDoveyField({
                    id: `age-${version.id}`,
                    label: t('age'),
                    placeholder: t('agePlaceholder'),
                    value: version.age || '',
                    itemType: 'loveydovey',
                    itemId: character.id,
                    versionId: version.id,
                    fieldName: 'age',
                    isTextarea: false,
                    maxLength: 15
                })}
                ${LoveyDoveyRenderer.createLoveyDoveyField({
                    id: `occupation-${version.id}`,
                    label: t('occupation'),
                    placeholder: t('occupationPlaceholder'),
                    value: version.occupation || '',
                    itemType: 'loveydovey',
                    itemId: character.id,
                    versionId: version.id,
                    fieldName: 'occupation',
                    isTextarea: false,
                    maxLength: 15
                })}
                ${LoveyDoveyRenderer.createLoveyDoveyField({
                    id: `characterQuote-${version.id}`,
                    label: t('characterQuote'),
                    placeholder: t('characterQuotePlaceholder'),
                    value: version.characterQuote || '',
                    itemType: 'loveydovey',
                    itemId: character.id,
                    versionId: version.id,
                    fieldName: 'characterQuote',
                    isTextarea: true,
                    maxLength: 80,
                    customStyle: 'height: 80px; resize: none;'
                })}
            </div>
        </div>

        <!-- üìå Á¨¨‰∫åÂçÄÔºöÂÖ¨ÈñãÊèèËø∞ -->
        <div style="margin-top: -20px;">
            ${LoveyDoveyRenderer.createLoveyDoveyField({
                id: `publicDescription-${version.id}`,
                label: t('publicDescription'),
                placeholder: t('publicDescriptionPlaceholder'),
                value: version.publicDescription || '',
                itemType: 'loveydovey',
                itemId: character.id,
                versionId: version.id,
                fieldName: 'publicDescription',
                isTextarea: true,
                maxLength: 700,
                customStyle: 'height: 120px; resize: vertical;'
            })}
        </div>

         <!-- üìå Á¨¨‰∏âÂçÄÔºöËßíËâ≤ÈÄ£ÁµêÁ∂≤ÂùÄ -->
        <div style="margin-top: -10px; margin-bottom: 30px;">
             ${LoveyDoveyRenderer.createLoveyDoveyField({
                id: `characterLinkUrl-${version.id}`,
                label: t('characterLinkUrl'), 
                placeholder: t('characterLinkUrlPlaceholder'),
                value: version.characterLinkUrl || '',
                itemType: 'loveydovey',
                itemId: character.id,
                versionId: version.id,
                fieldName: 'characterLinkUrl',
                isTextarea: false,
            })}
        </div>

        <!-- üìå Á¨¨ÂõõÂçÄÔºöÊ®ôÁ±§ -->
        <div class="field-group" style="margin-top: -10px;">
            <label class="field-label">${t('tags')}</label>
            ${TagInputManager.createTagInput({
                id: `tags-${version.id}`,
                value: version.tags || '',
                itemType: 'loveydovey',
                itemId: character.id,
                versionId: version.id,
                fieldName: 'tags',
                placeholder: t('tagsPlaceholder')
            })}
        </div>
    `;
}


    // Á¨¨‰∫åÂ§ßÂçÄÔºöÊ∏≤ÊüìËßíËâ≤Âü∫Êú¨Ë®≠ÂÆöÊ¨Ñ‰Ωç
    static renderBasicSettingsFields(character, version) {
    return `
        <!-- ÊÄßÂà•Ê¨Ñ‰Ωç -->
        <div class="field-group">
            <label class="field-label">${t('gender')}</label>
            <div style="display: flex; gap: 16px; margin-top: 8px;">
                <label class="radio-option" style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                    <input type="radio" name="gender-${version.id}" value="male" 
                        ${version.gender === 'male' ? 'checked' : ''}
                        onchange="updateField('loveydovey', '${character.id}', '${version.id}', 'gender', this.value);"
                        style="margin: 0;">
                    <span style="font-size: var(--font-lg); color: var(--text-color);">${t('male')}</span>
                </label>
                <label class="radio-option" style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                    <input type="radio" name="gender-${version.id}" value="female" 
                        ${version.gender === 'female' ? 'checked' : ''}
                        onchange="updateField('loveydovey', '${character.id}', '${version.id}', 'gender', this.value);"
                        style="margin: 0;">
                    <span style="font-size: var(--font-lg); color: var(--text-color);">${t('female')}</span>
                </label>
                <label class="radio-option" style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                    <input type="radio" name="gender-${version.id}" value="unset" 
                        ${version.gender === 'unset' || !version.gender ? 'checked' : ''}
                        onchange="updateField('loveydovey', '${character.id}', '${version.id}', 'gender', this.value);"
                        style="margin: 0;">
                    <span style="font-size: var(--font-lg); color: var(--text-color);">${t('unset')}</span>
                </label>
            </div>
        </div>

        <!-- Âü∫Êú¨Ë≥áË®ä -->
        ${LoveyDoveyRenderer.createLoveyDoveyField({
            id: `basicInfo-${version.id}`,
            label: t('basicInfo'),
            placeholder: t('basicInfoPlaceholder'),
            value: version.basicInfo || '',
            itemType: 'loveydovey',
            itemId: character.id,
            versionId: version.id,
            fieldName: 'basicInfo',
            isTextarea: true,
            maxLength: 700,
            customStyle: 'height: 120px; resize: vertical;'
        })}

        <!-- ÂÄãÊÄßÊëòË¶Å -->
        ${LoveyDoveyRenderer.createLoveyDoveyField({
            id: `personality-${version.id}`,
            label: t('personality'),
            placeholder: t('personalityPlaceholder'),
            value: version.personality || '',
            itemType: 'loveydovey',
            itemId: character.id,
            versionId: version.id,
            fieldName: 'personality',
            isTextarea: true,
            maxLength: 700,
            customStyle: 'height: 120px; resize: vertical;'
        })}

        <!-- Ë™™Ë©±È¢®Ê†ºËàáÁøíÊÖ£ -->
        ${LoveyDoveyRenderer.createLoveyDoveyField({
            id: `speakingStyle-${version.id}`,
            label: t('speakingStyle'),
            placeholder: t('speakingStylePlaceholder'),
            value: version.speakingStyle || '',
            itemType: 'loveydovey',
            itemId: character.id,
            versionId: version.id,
            fieldName: 'speakingStyle',
            isTextarea: true,
            maxLength: 700,
            customStyle: 'height: 120px; resize: vertical;'
        })}
    `;
}

    // Ê∏≤ÊüìÁ¨¨‰∏ÄÊ¨°ËÅäÂ§©Â†¥ÊôØÊ¨Ñ‰Ωç
    static renderFirstChatFields(character, version) {
    return `
        <!-- ÊÉÖÂ¢ÉËÖ≥Êú¨ -->
        ${LoveyDoveyRenderer.createLoveyDoveyField({
            id: `scenarioScript-${version.id}`,
            label: t('scenarioScript'),
            placeholder: t('scenarioScriptPlaceholder'),
            value: version.scenarioScript || '',
            itemType: 'loveydovey',
            itemId: character.id,
            versionId: version.id,
            fieldName: 'scenarioScript',
            isTextarea: true,
            maxLength: 800,
            customStyle: 'height: 120px; resize: vertical;'
        })}

        <!-- ËßíËâ≤Â∞çË©± -->
        ${LoveyDoveyRenderer.createLoveyDoveyField({
            id: `characterDialogue-${version.id}`,
            label: t('characterDialogue'),
            placeholder: t('characterDialoguePlaceholder'),
            value: version.characterDialogue || '',
            itemType: 'loveydovey',
            itemId: character.id,
            versionId: version.id,
            fieldName: 'characterDialogue',
            isTextarea: true,
            maxLength: 800,
            customStyle: 'height: 120px; resize: vertical;'
        })}
    `;
}

    // Ê∏≤ÊüìËßíËâ≤Ë©≥Á¥∞Ë®≠ÂÆöÊ¨Ñ‰Ωç
static renderDetailedSettingsFields(character, version) {
    return `
        <!-- ÂñúÊ≠° -->
        ${LoveyDoveyRenderer.createLoveyDoveyField({
            id: `likes-${version.id}`,
            label: t('likes'),
            placeholder: t('likesPlaceholder'),
            value: version.likes || '',
            itemType: 'loveydovey',
            itemId: character.id,
            versionId: version.id,
            fieldName: 'likes',
            isTextarea: false,
            maxLength: 50
        })}

        <!-- ‰∏çÂñúÊ≠° -->
        ${LoveyDoveyRenderer.createLoveyDoveyField({
            id: `dislikes-${version.id}`,
            label: t('dislikes'),
            placeholder: t('dislikesPlaceholder'),
            value: version.dislikes || '',
            itemType: 'loveydovey',
            itemId: character.id,
            versionId: version.id,
            fieldName: 'dislikes',
            isTextarea: false,
            maxLength: 50
        })}

        <!-- ÈôÑÂä†Ë≥áË®äÂãïÊÖãÂçÄÂüü -->
        <div id="additional-info-container-${version.id}">
            ${this.renderAdditionalInfoContainer(character, version)}
        </div>
    `;
}

       // Ê∏≤ÊüìÈôÑÂä†Ë≥áË®äÂÆπÂô®ÔºàÂåÖÂê´ÂàóË°®ÂíåÊåâÈàïÔºâ
    static renderAdditionalInfoContainer(character, version) {
        const additionalInfo = version.additionalInfo || [];
        const count = additionalInfo.length;
        const isOverRecommended = count > 10;
        
        return `
            <!-- ÈôÑÂä†Ë≥áË®äÂàóË°® -->
            <div id="additional-info-list-${version.id}" class="additional-info-sortable">
    ${this.renderAdditionalInfoList(character, version)}
</div>
            
            <!-- Ê∑ªÂä†ÊåâÈàï -->
            <div style="margin-bottom: 16px;">
   <button class="loveydovey-add-btn" onclick="addAdditionalInfo('${character.id}', '${version.id}')">
    ${IconManager.plus({width: 16, height: 16})}
    ${t('addAdditionalInfo')} (${count}/10)
</button>
            </div>
        `;
    }
// Ê∏≤ÊüìÈôÑÂä†Ë≥áË®äÂàóË°®
static renderAdditionalInfoList(character, version) {
    if (!version.additionalInfo || version.additionalInfo.length === 0) {
        return '';
    }

    return version.additionalInfo.map((info, index) => `
        <div class="additional-info-item sortable-item" data-info-id="${info.id}" 
             style="
                 background: var(--header-bg);
                 border: 1px solid var(--border-color);
                 border-radius: 8px;
                 padding: 12px 16px;
                 margin-bottom: 16px;
                 position: relative;
                 transition: all 0.2s ease;
             ">
             
            <!-- ÂèØÈªûÊìäÁöÑÊ®ôÈ°åÂàóÔºàÁî®ÊñºÊäòÁñäÔºâ -->
            <div class="additional-info-header" 
                 onclick="toggleAdditionalInfoCollapseLazy('${character.id}', '${version.id}', '${info.id}', ${index}, event)"
                 style="
                     display: flex; 
                     justify-content: space-between; 
                     align-items: flex-start; 
                     cursor: pointer;
                     padding: 4px 0;
                     margin-bottom: 0px;
                     border-radius: 4px;
                     transition: all 0.2s ease;
                 "
                 onmouseover="this.style.backgroundColor='var(--bg-color)'"
                 onmouseout="this.style.backgroundColor='transparent'">
                
                <div style="display: flex; align-items: flex-start; gap: 8px; flex: 1;">
                    <!-- ÊãñÊõ≥ÊéßÂà∂ÊüÑ -->
                    <div class="drag-handle" style="
                        cursor: grab;
                        color: var(--text-muted);
                        padding: 4px;
                        border-radius: 4px;
                        transition: all 0.2s ease;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        width: 20px;
                        height: 20px;
                        margin-top: 2px;
                        flex-shrink: 0;
                    " onmouseover="this.style.color='var(--text-color)'; this.style.backgroundColor='var(--border-color)'"
                       onmouseout="this.style.color='var(--text-muted)'; this.style.backgroundColor='transparent'">
                        ${IconManager.gripVertical({width: 12, height: 12, style: 'display: block;'})}
                    </div>
                    
                    <!-- Â±ïÈñãÊôÇÔºöÈ°ØÁ§∫„ÄåÈôÑÂä†Ë≥áË®ä N„Äç-->
                    <div class="info-title-expanded" id="title-expanded-${info.id}" style="display: none;">

                        <h4 style="margin: 0; font-size: 0.95em; font-weight: 600; color: var(--text-color);">
                            ${t('additionalInfo')} ${index + 1}
                        </h4>
                    </div>
                    
                    <!-- ÊäòÁñäÊôÇÔºöÈ°ØÁ§∫„ÄåÈôÑÂä†Ë≥áË®ä N - Ê®ôÈ°å„Äç -->
<div class="info-title-collapsed" id="title-collapsed-${info.id}" style="display: flex; flex: 1;">
    <div style="font-weight: 500; color: var(--text-color); font-size: 0.9em;">
        ${t('additionalInfo')} ${index + 1} Ôºç ${info.title || t('noTitle')}
    </div>
</div>
                </div>
                
                <!-- Âà™Èô§ÊåâÈàïÔºà‰ΩøÁî® SVG ÂúñÁ§∫Ôºâ -->
                <button class="delete-btn" 
        onclick="event.stopPropagation(); deleteAdditionalInfo('${character.id}', '${version.id}', '${info.id}')"
        style="flex-shrink: 0;">
    ${IconManager.delete()}
</button>
            </div>

            <!-- ÂèØÊäòÁñäÁöÑÂÖßÂÆπÂçÄÂüü -->
<div class="additional-info-content" id="content-${info.id}" style="display: none;">
    <!-- Content will be loaded lazily when expanded -->
            </div>
        </div>
    `).join('');
}

  // Ê∏≤ÊüìÂâµ‰ΩúËÄÖ‰∫ã‰ª∂Ê¨Ñ‰ΩçÔºàÁ¨¨‰∫îÂ§ßÂçÄÔºâ
static renderCreatorEventsFields(character, version) {
    const creatorEvents = version.creatorEvents || [];
    const count = creatorEvents.length;
    
    return `
        <!-- Ââµ‰ΩúËÄÖ‰∫ã‰ª∂ÂãïÊÖãÂçÄÂüü -->
        <div id="creator-events-container-${version.id}">
            <!-- Ââµ‰ΩúËÄÖ‰∫ã‰ª∂ÂàóË°® -->
            <div id="creator-events-list-${version.id}" class="creator-events-sortable">
                ${creatorEvents.length === 0 ? `
                    
                ` : creatorEvents.map((event, index) => `
                    <div class="creator-event-item sortable-item" data-event-id="${event.id}" 
                    style="
                        background: var(--header-bg);
                        border: 1px solid var(--border-color);
                        border-radius: 8px;
                        padding: 12px 16px;
                        margin-bottom: 16px;
                        position: relative;
                        transition: all 0.2s ease;
                    ">
                        
                       <!-- ÂèØÈªûÊìäÁöÑÊ®ôÈ°åÂàóÔºàÁî®ÊñºÊäòÁñäÔºâ -->
<div class="creator-event-header" 
     onclick="toggleCreatorEventCollapseLazy('${character.id}', '${version.id}', '${event.id}', ${index}, event)"
     style="
         display: flex; 
         justify-content: space-between; 
         align-items: flex-start; 
         cursor: pointer;
         padding: 4px 0;
         margin-bottom: 0px;
         border-radius: 4px;
         transition: all 0.2s ease;
     "
     onmouseover="this.style.backgroundColor='var(--bg-color)'"
     onmouseout="this.style.backgroundColor='transparent'">
    
    <div style="display: flex; align-items: flex-start; gap: 8px; flex: 1;">
    <!-- ÊãñÊõ≥ÊéßÂà∂ÊüÑ -->
    <div class="drag-handle" style="
        cursor: grab;
        color: var(--text-muted);
        padding: 4px;
        border-radius: 4px;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 20px;
        height: 20px;
        margin-top: 2px;
        flex-shrink: 0;
    " onmouseover="this.style.color='var(--text-color)'; this.style.backgroundColor='var(--border-color)'"
       onmouseout="this.style.color='var(--text-muted)'; this.style.backgroundColor='transparent'">
        ${IconManager.gripVertical({width: 12, height: 12, style: 'display: block;'})}
    </div>
        
        <!-- Â±ïÈñãÊôÇÔºöÈ°ØÁ§∫„ÄåÂâµ‰ΩúËÄÖ‰∫ã‰ª∂ N„Äç-->
<div class="event-title-expanded" id="title-expanded-${event.id}" style="display: none;">
            <h4 style="margin: 0; font-size: 0.95em; font-weight: 600; color: var(--text-color);">
                ${t('creatorEvent')} ${index + 1}
                ${event.isSecret ? IconManager.lock({width: 12, height: 12}) : ''}
            </h4>
        </div>
        
        <!-- ÊäòÁñäÊôÇÔºöÈ°ØÁ§∫Ê®ôÈ°å+ÊôÇÈñìÂú∞Èªû -->
        <div class="event-title-collapsed" id="title-collapsed-${event.id}" style="display: flex;
            flex-direction: column;
            gap: 2px;
            flex: 1;
            line-height: 1.3;
        ">
            <!-- ‰∏ªÊ®ôÈ°å -->
            <div style="
                font-weight: 600; 
                color: var(--text-color); 
                font-size: 0.95em;
                display: flex;
                align-items: center;
                gap: 8px;
                margin: 0;
                padding: 0;
            ">
                <span id="collapsed-title-text-${event.id}">${event.title || t('unnamedEvent')}</span>
                ${event.isSecret ? IconManager.lock({width: 12, height: 12}) : ''}
            </div>
            <!-- ÊôÇÈñìÂú∞Èªû -->
            <div id="collapsed-timeplace-text-${event.id}" style="
                font-size: 0.8em; 
                color: var(--text-muted); 
                font-style: italic;
                margin: 0;
                padding: 0;
                line-height: 1.2;
                ${!event.timeAndPlace ? 'display: none;' : ''}
            ">
                ${event.timeAndPlace}
            </div>
        </div>
    </div>
    
    <!-- Âà™Èô§ÊåâÈàïÔºà‰ΩøÁî® SVG ÂúñÁ§∫Ôºâ -->
<button class="delete-btn" 
        onclick="event.stopPropagation(); deleteCreatorEvent('${character.id}', '${version.id}', '${event.id}')"
        style="flex-shrink: 0;">
    ${IconManager.delete()}
</button>
</div>

                        <!-- ÂèØÊäòÁñäÁöÑÂÖßÂÆπÂçÄÂüü -->
<div class="creator-event-content" id="content-${event.id}" style="display: none;">
    <!-- Content will be loaded lazily when expanded -->
</div>
                        </div>
                    </div>
                `).join('')}
            </div>
            
            <!-- Ê∑ªÂä†ÊåâÈàï -->
            <div style="margin-bottom: 16px;">
   <button class="loveydovey-add-btn" onclick="addCreatorEvent('${character.id}', '${version.id}')" ${count >= 20 ? 'disabled' : ''}>
    ${IconManager.plus({width: 16, height: 16})}
    ${t('addCreatorEvents')} (${count}/20)
</button>
</div>
        </div>
    `;
}

// Ëá™ÂãïÂïüÁî®ÊãñÊõ≥
static initializeCreatorEventsDragSort(characterId, versionId) {
    setTimeout(() => {
        if (typeof enableCreatorEventsDragSort === 'function') {
            enableCreatorEventsDragSort(characterId, versionId);
        }
    }, 100);
}

// ÁîüÊàê‰∫ã‰ª∂È†êË¶ΩÊñáÂ≠ó
static generateEventPreview(event) {
    const timePlace = event.timeAndPlace || '';
    const title = event.title || '';
    
    if (timePlace && title) {
        return `${timePlace} - ${title}`;
    } else if (timePlace) {
        return timePlace;
    } else if (title) {
        return title;
    } else {
        return 'ÔºàÂ∞öÁÑ°ÂÖßÂÆπÔºâ';
    }
}

    
    // ÊäòÁñäÂ±ïÈñãÂäüËÉΩ  
static toggleSection(sectionName, event = null) {
    let section;
    
    if (event) {
        // Êô∫ÊÖßÊü•ÊâæÔºöÂú®ÈªûÊìäÂÖÉÁ¥†ÁöÑÁâàÊú¨ÂÆπÂô®ÂÖßÊü•Êâæ
        const versionContainer = event.target.closest('.version-content');
        section = versionContainer ? 
            versionContainer.querySelector(`[data-section="${sectionName}"]`) :
            document.querySelector(`[data-section="${sectionName}"]`);
    } else {
        // ÂêëÂæåÁõ∏ÂÆπÔºöÊ≤íÊúâeventÊôÇ‰ΩøÁî®ÂéüÈÇèËºØ
        section = document.querySelector(`[data-section="${sectionName}"]`);
    }
    
    if (!section) return;
    
    const content = section.querySelector('.collapsible-content');
    const arrowIcon = section.querySelector('.arrow-icon');
    
    if (content.style.display === 'none') {
        // Â±ïÈñã
        content.style.display = 'block';
        if (arrowIcon) {
            arrowIcon.classList.remove('arrow-right');
            arrowIcon.classList.add('arrow-down');
        }
    } else {
        // ÊäòÁñä
        content.style.display = 'none';
        if (arrowIcon) {
            arrowIcon.classList.remove('arrow-down');
            arrowIcon.classList.add('arrow-right');
        }
    }
}

// ÂçøÂçøÊàëÊàëÂ∞àÁî®Ê¨Ñ‰ΩçÂâµÂª∫ÂáΩÊï∏
static createLoveyDoveyField(config) {
    const {
        id, label, placeholder, value = '', 
        itemType, itemId, versionId, fieldName,
        isTextarea = false, maxLength = 0,
        customStyle = '', rows = 3
    } = config;

    const currentLength = (value || '').length;
    const isOverLimit = maxLength > 0 && currentLength > maxLength;
    const showStats = maxLength > 0;
    const isQuoteField = fieldName === 'characterQuote';

    // Áµ±Ë®àÊñáÂ≠óÊ®£Âºè
    const statsStyle = isOverLimit ? 'color: #e74c3c; font-weight: bold;' : 'color: var(--text-muted);';

    // Ëº∏ÂÖ•Ê°ÜÊ®£Âºè
    const inputBorderStyle = isOverLimit ? 'border-color: #e74c3c; box-shadow: 0 0 0 2px rgba(231, 76, 60, 0.2);' : '';

    // === ‰∏ªËº∏ÂÖ•Ê¨Ñ‰Ωç ===
    const inputElement = isTextarea ? 
        `<textarea 
    class="field-input"
    id="${id}" 
    placeholder="${placeholder}"
    style="${isQuoteField 
    ? 'height: 92px; min-height: 92px; max-height: 92px; resize: none; overflow-y: hidden; padding: 12px 16px; line-height: 1.5; scrollbar-width: none; -ms-overflow-style: none;' 
    : (customStyle || 'min-height: 200px; max-height: 70vh; resize: vertical;')} ${inputBorderStyle}"
    oninput="updateLoveyDoveyFieldWithPath('${itemType}', '${itemId}', '${versionId}', '${fieldName}', this.value, ${maxLength});">${value}</textarea>`
        :
        `<input 
        type="text" 
        class="field-input" 
        id="${id}" 
        placeholder="${placeholder}"
        style="${inputBorderStyle}"
        oninput="updateLoveyDoveyFieldWithPath('${itemType}', '${itemId}', '${versionId}', '${fieldName}', this.value, ${maxLength})"
        value="${value}"
    >`;
    
    // === ÂÖ®Ëû¢ÂπïÊåâÈàïÔºàÂè™Êúâ textarea ÊâçÈ°ØÁ§∫Ôºâ===
    const fullscreenBtn = (isTextarea && fieldName !== 'characterQuote') ? 
        `<button 
            class="fullscreen-btn" 
            onclick="openFullscreenEditor('${id}', '${label}')" 
            title="${t('fullscreenEdit')}" 
            style="margin-left: 8px;"
        >‚õ∂</button>` 
        : '';

    // === Ëº∏Âá∫Êï¥È´î ===
    return `
        <div class="field-group">
            <label class="field-label">
                ${label}
                ${showStats ? `<span class="loveydovey-char-count" data-target="${id}" style="margin-left: 12px; font-size: 0.85em; ${statsStyle}">${currentLength} / ${maxLength} ${t('chars')}</span>` : ''}
                ${fullscreenBtn}
            </label>
            ${inputElement}
        </div>
    `;
}
    
}


function hideEventFullscreenBtn(textarea) {
    setTimeout(() => {
        const container = textarea.parentElement;
        const btn = container.querySelector('.event-fullscreen-btn');
        if (btn) {
            btn.style.opacity = '0';
            btn.style.visibility = 'hidden';
            btn.style.transform = 'translateX(-8px)';
        }
    }, 150);
}


// ÂçøÂçøÊàëÊàëÂúñÁâá‰∏äÂÇ≥Ëß∏ÁôºÂáΩÊï∏
function triggerLoveyDoveyImageUpload(itemId, versionId) {
    const fileInput = document.getElementById(`profileImage-upload-${versionId}`);
    if (fileInput) {
        fileInput.click();
    }
}

// ÂçøÂçøÊàëÊàëÂ∞àÁî®ÂúñÁâá‰∏äÂÇ≥ÂáΩÊï∏
async function handleLoveyDoveyImageUpload(itemId, versionId, file = null) {
    if (!file) {
        const fileInput = document.getElementById(`profileImage-upload-${versionId}`);
        if (fileInput) {
            fileInput.click();
        }
        return;
    }
    
    // ‰ΩøÁî®Ë£ÅÂàáÂô®
    ImageCropper.show(file, '1:1', async (croppedDataUrl) => {
        updateField('loveydovey', itemId, versionId, 'profileImage', croppedDataUrl);
        renderContent();
    });
}

// ÂçøÂçøÊàëÊàëÂ∞àÁî®Ê¨Ñ‰ΩçÊõ¥Êñ∞ÂáΩÊï∏
function updateLoveyDoveyField(itemType, itemId, versionId, fieldName, value, maxLength = 0) {
    // Êõ¥Êñ∞Ë≥áÊñô
    updateField(itemType, itemId, versionId, fieldName, value);
    
    // Êõ¥Êñ∞Â≠óÊï∏Áµ±Ë®àÈ°ØÁ§∫
    if (maxLength > 0) {
        updateLoveyDoveyCharCount(itemId, versionId, fieldName, value, maxLength);
    }
}

    function updateLoveyDoveyCharCount(itemId, versionId, fieldName, value, maxLength) {
    let inputId;
    
    // ËôïÁêÜÈôÑÂä†Ë≥áË®äÊ¨Ñ‰ΩçÁöÑ ID
    if (fieldName.startsWith('additionalInfo.')) {
        const pathParts = fieldName.split('.');
        const index = pathParts[1];
        const field = pathParts[2];
        
        // ÊâæÂà∞Â∞çÊáâÁöÑ info ID
        const character = loveyDoveyCharacters.find(c => c.id === itemId);
        if (character) {
            const version = character.versions.find(v => v.id === versionId);
            if (version && version.additionalInfo && version.additionalInfo[index]) {
                const infoId = version.additionalInfo[index].id;
                inputId = `additional${field.charAt(0).toUpperCase() + field.slice(1)}-${infoId}`;
            }
        }
    } 
    // ËôïÁêÜÂâµ‰ΩúËÄÖ‰∫ã‰ª∂Ê¨Ñ‰ΩçÁöÑ ID
    else if (fieldName.startsWith('creatorEvents.')) {
        const pathParts = fieldName.split('.');
        const index = pathParts[1];
        const field = pathParts[2];
        
        // ÊâæÂà∞Â∞çÊáâÁöÑ event ID
        const character = loveyDoveyCharacters.find(c => c.id === itemId);
        if (character) {
            const version = character.versions.find(v => v.id === versionId);
            if (version && version.creatorEvents && version.creatorEvents[index]) {
                const eventId = version.creatorEvents[index].id;
                switch (field) {
                    case 'timeAndPlace':
                        inputId = `eventTimeAndPlace-${eventId}`;
                        break;
                    case 'title':
                        inputId = `eventTitle-${eventId}`;
                        break;
                    case 'content':
                        inputId = `eventContent-${eventId}`;
                        break;
                }
            }
        }
    } 
    else {
        // ÊôÆÈÄöÊ¨Ñ‰Ωç
        inputId = `${fieldName}-${versionId}`;
    }
        
    if (!inputId) {
        console.warn('ÁÑ°Ê≥ïÁîüÊàêinputId:', { itemId, versionId, fieldName });
        return;
    }
        
    // Êü•ÊâæÁµ±Ë®àÂÖÉÁ¥†ÔºàÊ°ÜÂ§ñÈù¢ÁöÑÈ°ØÁ§∫Ôºâ
    const countElement = document.querySelector(`[data-target="${inputId}"]`);
    const inputElement = document.getElementById(inputId);
    
    if (!countElement) {
        console.warn('Êâæ‰∏çÂà∞Â≠óÊï∏Áµ±Ë®àÂÖÉÁ¥†:', inputId);
        return;
    }
    
    if (!inputElement) {
        console.warn('Êâæ‰∏çÂà∞Ëº∏ÂÖ•ÂÖÉÁ¥†:', inputId);
        return;
    }
    
    const currentLength = (value || '').length;
    const isOverLimit = currentLength > maxLength;
    
    // Êõ¥Êñ∞Áµ±Ë®àÊñáÂ≠ó
    countElement.textContent = `${currentLength} / ${maxLength} ${t('chars')}`;
    
    // Êõ¥Êñ∞Áµ±Ë®àÊñáÂ≠óÈ°èËâ≤
    if (isOverLimit) {
        countElement.style.color = '#e74c3c';
        countElement.style.fontWeight = 'bold';
    } else {
        countElement.style.color = 'var(--text-muted)';
        countElement.style.fontWeight = 'normal';
    }
    
    // Êõ¥Êñ∞Ëº∏ÂÖ•Ê°ÜÈÇäÊ°Ü
    if (isOverLimit) {
        inputElement.style.borderColor = '#e74c3c';
        inputElement.style.boxShadow = '0 0 0 2px rgba(231, 76, 60, 0.2)';
        inputElement.classList.add('loveydovey-error');
    } else {
        inputElement.style.borderColor = '';
        inputElement.style.boxShadow = '';
        inputElement.classList.remove('loveydovey-error');
    }
    
    
}


// ===== ÂçøÂçøÊàëÊàëÈôÑÂä†Ë≥áË®äÁÆ°ÁêÜÂáΩÊï∏ =====

// Êñ∞Â¢ûÈôÑÂä†Ë≥áË®ä
let isAdding = false;
let isAddingEvent = false;
function addAdditionalInfo(characterId, versionId) {
    if (isAdding) return; // Èò≤Ê≠¢ÈáçË§áËß∏Áôº
    isAdding = true;
    
    // ‰øùÂ≠òÁï∂ÂâçÁãÄÊÖã
    const currentStates = getCurrentAdditionalInfoCollapseStates();
    
    const character = loveyDoveyCharacters.find(c => c.id === characterId);
    if (!character) {
        isAdding = false;
        return;
    }
    
    const version = character.versions.find(v => v.id === versionId);
    if (!version) {
        isAdding = false;
        return;
    }
    
    // ÂàùÂßãÂåñ additionalInfo Èô£ÂàóÔºàÂ¶ÇÊûú‰∏çÂ≠òÂú®Ôºâ
    if (!version.additionalInfo) {
        version.additionalInfo = [];
    }
    
    // ÂâµÂª∫Êñ∞ÁöÑÈôÑÂä†Ë≥áË®ä
    const newInfo = {
        id: generateId(),
        title: '',
        content: ''
    };
    
    version.additionalInfo.push(newInfo);
    
    // Êõ¥Êñ∞ÊôÇÈñìÊà≥Ë®ò
    TimestampManager.updateVersionTimestamp('loveydovey', characterId, versionId);
    markAsChanged();
    
    //  ‰ΩøÁî® requestAnimationFrame Ê∏õÂ∞ëÈñÉÁèæ
    requestAnimationFrame(() => {
        renderAdditionalInfoList(characterId, versionId);
        
        setTimeout(() => {
            restoreAdditionalInfoCollapseStates(currentStates);
            // ÈáçÊñ∞ÂïüÁî®ÊãñÊõ≥ÂäüËÉΩ
            if (typeof DragSortManager !== 'undefined') {
                DragSortManager.enableAdditionalInfoDragSort(characterId, versionId);
            }
            
            // Ëß£Èô§ÈéñÂÆö
            isAdding = false;
        }, 16); // ‰∏ÄÂÄãframeÁöÑÊôÇÈñì
    });
}

// Âà™Èô§ÈôÑÂä†Ë≥áË®ä
function deleteAdditionalInfo(characterId, versionId, infoId) {
    const confirmDelete = confirm('Á¢∫ÂÆöË¶ÅÂà™Èô§Ê≠§ÈôÑÂä†Ë≥áË®äÂóéÔºü\n\n‚ö†Ô∏è Âà™Èô§ÂæåÁÑ°Ê≥ïÂæ©ÂéüÔºÅ');
    
    if (!confirmDelete) return;
    
    //  Âú®Âà™Èô§ÂâçÂÖà‰øùÂ≠òÂÖ∂‰ªñÈ†ÖÁõÆÁöÑÊäòÁñäÁãÄÊÖã
    const currentStates = getCurrentAdditionalInfoCollapseStates();
    // ÁßªÈô§Âç≥Â∞áË¢´Âà™Èô§ÁöÑÈ†ÖÁõÆÁãÄÊÖã
    delete currentStates[infoId];
    
    const character = loveyDoveyCharacters.find(c => c.id === characterId);
    if (!character) return;
    
    const version = character.versions.find(v => v.id === versionId);
    if (!version || !version.additionalInfo) return;
    
    // ÁßªÈô§ÊåáÂÆöÁöÑÈôÑÂä†Ë≥áË®ä
    version.additionalInfo = version.additionalInfo.filter(info => info.id !== infoId);
    
    // Êõ¥Êñ∞ÊôÇÈñìÊà≥Ë®ò
    TimestampManager.updateVersionTimestamp('loveydovey', characterId, versionId);
    markAsChanged();
    
    //  ÈáçÊñ∞Ê∏≤ÊüìÈôÑÂä†Ë≥áË®äÂàóË°®
    renderAdditionalInfoList(characterId, versionId);
    
    //  ÊÅ¢Âæ©ÂÖ∂‰ªñÈ†ÖÁõÆÁöÑÊäòÁñäÁãÄÊÖã
    setTimeout(() => {
        restoreAdditionalInfoCollapseStates(currentStates);
        // ÈáçÊñ∞ÂïüÁî®ÊãñÊõ≥ÂäüËÉΩ
        if (typeof DragSortManager !== 'undefined') {
            DragSortManager.enableAdditionalInfoDragSort(characterId, versionId);
        }
    }, 50);
}

// Êõ¥Êñ∞ÈôÑÂä†Ë≥áË®äÊ¨Ñ‰Ωç
function updateAdditionalInfoField(characterId, versionId, fieldPath, value, maxLength = 0) {
    // Ëá®ÊôÇË™øË©¶
    const character = loveyDoveyCharacters.find(c => c.id === characterId);
    if (!character) return;
    
    const version = character.versions.find(v => v.id === versionId);
    if (!version || !version.additionalInfo) return;
    
    // Ëß£ÊûêÊ¨Ñ‰ΩçË∑ØÂæë "additionalInfo.0.title" -> [0, 'title']
    const pathParts = fieldPath.split('.');
    if (pathParts.length !== 3 || pathParts[0] !== 'additionalInfo') return;
    
    const index = parseInt(pathParts[1]);
    const field = pathParts[2];
    
    if (index < 0 || index >= version.additionalInfo.length) return;
    
    // Êõ¥Êñ∞Ê¨Ñ‰ΩçÂÄº
    version.additionalInfo[index][field] = value;
    
    // Êõ¥Êñ∞ÊôÇÈñìÊà≥Ë®ò
    TimestampManager.updateVersionTimestamp('loveydovey', characterId, versionId);
    markAsChanged();
    updateAllPageStats();
}

function renderAdditionalInfoList(characterId, versionId) {
    const character = loveyDoveyCharacters.find(c => c.id === characterId);
    if (!character) return;
    
    const version = character.versions.find(v => v.id === versionId);
    if (!version) return;
    
    const container = document.getElementById(`additional-info-container-${versionId}`);
    if (!container) return;
    
    // ÈáçÊñ∞Ê∏≤ÊüìÊï¥ÂÄãÂÆπÂô®ÔºàÂåÖÂê´ÊåâÈàïÔºâ
    container.innerHTML = LoveyDoveyRenderer.renderAdditionalInfoContainer(character, version);
    
    // ÈáçÊñ∞ÂàùÂßãÂåñÂäüËÉΩ
    setTimeout(() => {
        initAutoResize();
        updateAllPageStats();
        // ÂïüÁî®ÈôÑÂä†Ë≥áË®äÊãñÊõ≥ÊéíÂ∫è
        if (typeof DragSortManager !== 'undefined') {
            DragSortManager.enableAdditionalInfoDragSort(characterId, versionId);
        }
        
    }, 50);
}

// ÊîØÊè¥Ë∑ØÂæëÊõ¥Êñ∞ÁöÑÂçøÂçøÊàëÊàëÊ¨Ñ‰ΩçÊõ¥Êñ∞ÂáΩÊï∏
function updateLoveyDoveyFieldWithPath(itemType, itemId, versionId, fieldPath, value, maxLength = 0) {
    // Â¶ÇÊûúÊòØÈôÑÂä†Ë≥áË®äÊ¨Ñ‰ΩçÔºå‰ΩøÁî®Â∞àÈñÄÁöÑÂáΩÊï∏
    if (fieldPath.startsWith('additionalInfo.')) {
        updateAdditionalInfoField(itemId, versionId, fieldPath, value, maxLength);
        
        // Êõ¥Êñ∞Â≠óÊï∏Áµ±Ë®à
        if (maxLength > 0) {
            updateLoveyDoveyCharCount(itemId, versionId, fieldPath, value, maxLength);
        }
    } 
    //  Â¶ÇÊûúÊòØÂâµ‰ΩúËÄÖ‰∫ã‰ª∂Ê¨Ñ‰ΩçÔºå‰ΩøÁî®Â∞àÈñÄÁöÑÂáΩÊï∏
    else if (fieldPath.startsWith('creatorEvents.')) {
        updateCreatorEventField(itemId, versionId, fieldPath, value);
        
        // Êõ¥Êñ∞Â≠óÊï∏Áµ±Ë®à
        if (maxLength > 0) {
            updateLoveyDoveyCharCount(itemId, versionId, fieldPath, value, maxLength);
        }
    } 
    else {
        // ÊôÆÈÄöÊ¨Ñ‰Ωç‰ΩøÁî®ÂéüÊúâÂáΩÊï∏
        updateLoveyDoveyField(itemType, itemId, versionId, fieldPath, value, maxLength);
    }
}

// È°ØÁ§∫ÈôÑÂä†Ë≥áË®äÁöÑÂÖ®Ëû¢ÂπïÊåâÈàï
function showAdditionalFullscreenBtn(textarea) {
    const container = textarea.parentElement;
    const btn = container.querySelector('.fullscreen-btn-toolbar');
    if (btn) {
        btn.style.opacity = '1';
        btn.style.visibility = 'visible';
        btn.style.transform = 'translateX(0)';
    }
}

// Èö±ËóèÈôÑÂä†Ë≥áË®äÁöÑÂÖ®Ëû¢ÂπïÊåâÈàï
function hideAdditionalFullscreenBtn(textarea) {
    setTimeout(() => {
        const container = textarea.parentElement;
        const btn = container.querySelector('.fullscreen-btn-toolbar');
        if (btn) {
            btn.style.opacity = '0';
            btn.style.visibility = 'hidden';
            btn.style.transform = 'translateX(-8px)';
        }
    }, 150);
}
// ===== Ââµ‰ΩúËÄÖ‰∫ã‰ª∂ÁÆ°ÁêÜÂáΩÊï∏ =====

// Êñ∞Â¢ûÂâµ‰ΩúËÄÖ‰∫ã‰ª∂
function addCreatorEvent(characterId, versionId) {
    // ‰øùÂ≠òÁï∂ÂâçÁãÄÊÖã
    const currentStates = getCurrentCreatorEventCollapseStates();
    
    const character = loveyDoveyCharacters.find(c => c.id === characterId);
    if (!character) return;
    
    const version = character.versions.find(v => v.id === versionId);
    if (!version) return;
    
    // ÂàùÂßãÂåñ creatorEvents Èô£Âàó
    if (!version.creatorEvents) {
        version.creatorEvents = [];
    }
    
    // Ê™¢Êü•Êï∏ÈáèÈôêÂà∂
    if (version.creatorEvents.length >= 20) {
        alert('ÊúÄÂ§öÂè™ËÉΩÊ∑ªÂä†20ÂÄãÂâµ‰ΩúËÄÖ‰∫ã‰ª∂');
        return;
    }
    
    // ÂâµÂª∫Êñ∞ÁöÑÂâµ‰ΩúËÄÖ‰∫ã‰ª∂
    const newEvent = {
        id: generateId(),
        timeAndPlace: '',
        title: '',
        content: '',
        isSecret: false
    };
    
    version.creatorEvents.push(newEvent);
    
    // Êõ¥Êñ∞ÊôÇÈñìÊà≥Ë®òÂíåÊ®ôË®òËÆäÊõ¥
    TimestampManager.updateVersionTimestamp('loveydovey', characterId, versionId);
    markAsChanged();
    const container = document.getElementById(`creator-events-container-${versionId}`);
    if (container) {
        container.innerHTML = LoveyDoveyRenderer.renderCreatorEventsFields(character, version);
    }
    
    // ÊÅ¢Âæ©‰πãÂâçÁöÑÊäòÁñäÁãÄÊÖã‰∏¶ÈáçÊñ∞ÂïüÁî®ÊãñÊõ≥
    setTimeout(() => {
        restoreCreatorEventCollapseStates(currentStates);
        if (typeof enableCreatorEventsDragSort === 'function') {
            enableCreatorEventsDragSort(characterId, versionId);
        }
    }, 50);
}

// Âà™Èô§Ââµ‰ΩúËÄÖ‰∫ã‰ª∂
function deleteCreatorEvent(characterId, versionId, eventId) {
    const confirmDelete = confirm('Á¢∫ÂÆöË¶ÅÂà™Èô§Ê≠§Ââµ‰ΩúËÄÖ‰∫ã‰ª∂ÂóéÔºü\n\n‚ö†Ô∏è Âà™Èô§ÂæåÁÑ°Ê≥ïÂæ©ÂéüÔºÅ');
    
    if (!confirmDelete) return;
    
    const character = loveyDoveyCharacters.find(c => c.id === characterId);
    if (!character) return;
    
    const version = character.versions.find(v => v.id === versionId);
    if (!version || !version.creatorEvents) return;
    
    // ÁßªÈô§ÊåáÂÆöÁöÑÂâµ‰ΩúËÄÖ‰∫ã‰ª∂
    version.creatorEvents = version.creatorEvents.filter(event => event.id !== eventId);
    
    // Êõ¥Êñ∞ÊôÇÈñìÊà≥Ë®òÂíåÊ®ôË®òËÆäÊõ¥
    TimestampManager.updateVersionTimestamp('loveydovey', characterId, versionId);
    markAsChanged();
    
    // ÈáçÊñ∞Ê∏≤Êüì
    renderAll();
}

// Êõ¥Êñ∞Ââµ‰ΩúËÄÖ‰∫ã‰ª∂Ê¨Ñ‰Ωç
function updateCreatorEventField(characterId, versionId, fieldPath, value) {
    const character = loveyDoveyCharacters.find(c => c.id === characterId);
    if (!character) return;
    
    const version = character.versions.find(v => v.id === versionId);
    if (!version || !version.creatorEvents) return;
    
    // Ëß£ÊûêÊ¨Ñ‰ΩçË∑ØÂæë "creatorEvents.0.title" -> [0, 'title']
    const pathParts = fieldPath.split('.');
    if (pathParts.length !== 3 || pathParts[0] !== 'creatorEvents') return;
    
    const index = parseInt(pathParts[1]);
    const field = pathParts[2];
    
    if (index < 0 || index >= version.creatorEvents.length) return;
    
    // Êõ¥Êñ∞Ê¨Ñ‰ΩçÂÄº
    version.creatorEvents[index][field] = value;
    
    // Êõ¥Êñ∞ÊôÇÈñìÊà≥Ë®òÂíåÊ®ôË®òËÆäÊõ¥
    TimestampManager.updateVersionTimestamp('loveydovey', characterId, versionId);
    markAsChanged();
    updateAllPageStats();
}

// ÂàáÊèõÂâµ‰ΩúËÄÖ‰∫ã‰ª∂ÁöÑÁßòÂØÜË®≠ÁΩÆ
function toggleCreatorEventSecret(characterId, versionId, eventId) {
    const character = loveyDoveyCharacters.find(c => c.id === characterId);
    if (!character) return;
    
    const version = character.versions.find(v => v.id === versionId);
    if (!version || !version.creatorEvents) return;
    
    const event = version.creatorEvents.find(e => e.id === eventId);
    if (!event) return;
    
    // ÂàáÊèõÁßòÂØÜË®≠ÁΩÆ
    event.isSecret = !event.isSecret;
    
    // Êõ¥Êñ∞ÊôÇÈñìÊà≥Ë®òÂíåÊ®ôË®òËÆäÊõ¥
    TimestampManager.updateVersionTimestamp('loveydovey', characterId, versionId);
    markAsChanged();
    
    // Áõ¥Êé•Êõ¥Êñ∞ DOMÔºå‰∏çÈáçÊñ∞Ê∏≤Êüì
    updateSecretIconsForEvent(eventId, event.isSecret);
}

// Áõ¥Êé•Êõ¥Êñ∞ÊåáÂÆö‰∫ã‰ª∂ÁöÑÁßòÂØÜÂúñÁ§∫
function updateSecretIconsForEvent(eventId, isSecret) {
    const lockSvg = IconManager.lock({width: 12, height: 12});
    const settingLockSvg = IconManager.lock({width: 14, height: 14});
    
    // 1. Êõ¥Êñ∞Â±ïÈñãÁãÄÊÖãÊ®ôÈ°å‰∏≠ÁöÑÂúñÁ§∫
    const titleExpanded = document.getElementById(`title-expanded-${eventId}`);
    if (titleExpanded) {
        const h4 = titleExpanded.querySelector('h4');
        if (h4) {
            // ÁßªÈô§ÁèæÊúâÁöÑ SVG
            const existingSvg = h4.querySelector('svg');
            if (existingSvg) {
                existingSvg.remove();
            }
            
            // Â¶ÇÊûúÊòØÁßòÂØÜÔºåÊ∑ªÂä† SVG
            if (isSecret) {
                h4.insertAdjacentHTML('beforeend', lockSvg);
            }
        }
    }
    
    // 2. Êõ¥Êñ∞ÊäòÁñäÁãÄÊÖãÊ®ôÈ°å‰∏≠ÁöÑÂúñÁ§∫
    const titleCollapsed = document.getElementById(`title-collapsed-${eventId}`);
    if (titleCollapsed) {
        const titleDiv = titleCollapsed.querySelector('div:first-child');
        if (titleDiv) {
            // ÁßªÈô§ÁèæÊúâÁöÑ SVG
            const existingSvg = titleDiv.querySelector('svg');
            if (existingSvg) {
                existingSvg.remove();
            }
            
            // Â¶ÇÊûúÊòØÁßòÂØÜÔºåÊ∑ªÂä† SVG
            if (isSecret) {
                titleDiv.insertAdjacentHTML('beforeend', lockSvg);
            }
        }
    }
    
    // 3. Êõ¥Êñ∞Ë®≠ÁΩÆÂçÄÂüüÁöÑÂúñÁ§∫
    const container = document.querySelector(`[data-event-id="${eventId}"]`);
    if (container) {
        const settingLabel = container.querySelector('input[type="checkbox"] + span');
        if (settingLabel) {
            // ÁßªÈô§ÁèæÊúâÁöÑ SVG
            const existingSvg = settingLabel.querySelector('svg');
            if (existingSvg) {
                existingSvg.remove();
            }
            
            // Â¶ÇÊûúÊòØÁßòÂØÜÔºåÊ∑ªÂä† SVG
            if (isSecret) {
                settingLabel.insertAdjacentHTML('beforeend', settingLockSvg);
            }
        }
    }
    
    
}

// ===== Ââµ‰ΩúËÄÖ‰∫ã‰ª∂ÊäòÁñäÂäüËÉΩ =====

// Â≠òÂÑ≤ÊäòÁñäÁãÄÊÖã
let creatorEventCollapseStates = {};

// ÂàáÊèõÂâµ‰ΩúËÄÖ‰∫ã‰ª∂ÁöÑÊäòÁñäÁãÄÊÖã
function toggleCreatorEventCollapse(eventId, event = null) {
    let content, titleExpanded, titleCollapsed;
    
    if (event) {
        // Êô∫ÊÖßÊü•ÊâæÔºöÂú®ÈªûÊìäÂÖÉÁ¥†ÁöÑÁâàÊú¨ÂÆπÂô®ÂÖßÊü•Êâæ
        const versionContainer = event.target.closest('.version-content');
        if (versionContainer) {
            content = versionContainer.querySelector(`#content-${eventId}`);
            titleExpanded = versionContainer.querySelector(`#title-expanded-${eventId}`);
            titleCollapsed = versionContainer.querySelector(`#title-collapsed-${eventId}`);
        }
    }
    
    // Â¶ÇÊûúÊô∫ÊÖßÊü•ÊâæÂ§±ÊïóÔºå‰ΩøÁî®ÂéüÈÇèËºØ
    if (!content) {
        content = document.getElementById(`content-${eventId}`);
        titleExpanded = document.getElementById(`title-expanded-${eventId}`);
        titleCollapsed = document.getElementById(`title-collapsed-${eventId}`);
    }
    
    if (!content || !titleExpanded || !titleCollapsed) return;
    
    const isCollapsed = content.style.display === 'none';
    
    if (isCollapsed) {
        // Â±ïÈñã
        content.style.display = 'block';
        titleExpanded.style.display = 'block';
        titleCollapsed.style.display = 'none';
    } else {
        // ÊäòÁñä
        content.style.display = 'none';
        titleExpanded.style.display = 'none';
        titleCollapsed.style.display = 'flex';
    }
    
    //  ‰øùÂ≠òÁãÄÊÖã
    saveCollapseStates();
}

//  Áç≤ÂèñÁï∂ÂâçÊâÄÊúâ‰∫ã‰ª∂ÁöÑÊäòÁñäÁãÄÊÖã
function getCurrentCollapseStates() {
    const states = {};
    document.querySelectorAll('.creator-event-item').forEach(item => {
        const eventId = item.dataset.eventId;
        const content = document.getElementById(`content-${eventId}`);
        if (content) {
            states[eventId] = content.style.display === 'none';
        }
    });
    return states;
}

//  ÊÅ¢Âæ©ÊâÄÊúâ‰∫ã‰ª∂ÁöÑÊäòÁñäÁãÄÊÖã
function restoreCollapseStates(states) {
    Object.keys(states).forEach(eventId => {
        if (states[eventId]) {
            // ÈúÄË¶ÅÊäòÁñä
            const content = document.getElementById(`content-${eventId}`);
            const titleExpanded = document.getElementById(`title-expanded-${eventId}`);
            const titleCollapsed = document.getElementById(`title-collapsed-${eventId}`);
            
            if (content && titleExpanded && titleCollapsed) {
                content.style.display = 'none';
                titleExpanded.style.display = 'none';
                titleCollapsed.style.display = 'flex';
            }
        }
    });
}

// Êõ¥Êñ∞ÊäòÁñäÊôÇÁöÑÊ®ôÈ°åÈ°ØÁ§∫
function updateEventCollapsedTitle(eventId) {
    const titleCollapsed = document.getElementById(`title-collapsed-${eventId}`);
    if (!titleCollapsed) return;
    
    // ÂæûÂ∞çÊáâÁöÑËº∏ÂÖ•Ê°ÜÁç≤ÂèñÊúÄÊñ∞ÂÄº
    const container = document.querySelector(`[data-event-id="${eventId}"]`);
    if (!container) return;
    
    const timePlace = container.querySelector('input[id^="eventTimeAndPlace-"]')?.value || '';
    const title = container.querySelector('input[id^="eventTitle-"]')?.value || '';
    
    // Êõ¥Êñ∞Ê®ôÈ°åÈ°ØÁ§∫
    const titleElement = titleCollapsed.querySelector('div:first-child');
    if (titleElement) {
        const secretIcon = titleElement.querySelector('span[style*="warning-color"]');
        const secretHtml = secretIcon ? secretIcon.outerHTML : '';
        titleElement.innerHTML = `${title || t('unnamedEvent')} ${secretHtml}`;
    }
    
    // Êõ¥Êñ∞ÊôÇÈñìÂú∞ÈªûÈ°ØÁ§∫
    const timePlaceElement = titleCollapsed.querySelector('div:last-child');
    if (timePlaceElement) {
        if (timePlace) {
            timePlaceElement.style.display = 'block';
            timePlaceElement.textContent = timePlace;
        } else {
            timePlaceElement.style.display = 'none';
        }
    }
}

// ===== Ââµ‰ΩúËÄÖ‰∫ã‰ª∂ÊãñÊõ≥ÊéíÂ∫èÂäüËÉΩ =====
// ÂïüÁî®Ââµ‰ΩúËÄÖ‰∫ã‰ª∂ÁöÑÊãñÊõ≥ÊéíÂ∫è
function enableCreatorEventsDragSort(characterId, versionId) {
    const container = document.getElementById(`creator-events-list-${versionId}`);
    if (!container || typeof Sortable === 'undefined') {
        console.warn('ÁÑ°Ê≥ïÂïüÁî®Ââµ‰ΩúËÄÖ‰∫ã‰ª∂ÊãñÊõ≥ÊéíÂ∫èÔºöÂÆπÂô®‰∏çÂ≠òÂú®Êàñ Sortable Êú™ËºâÂÖ•');
        return;
    }
    
    // Ê™¢Êü•ÊòØÂê¶Â∑≤Á∂ìÂïüÁî®
    if (container._sortable) {
        container._sortable.destroy();
    }
    
    let savedStates = {}; //  ‰øùÂ≠òÊäòÁñäÁãÄÊÖã
    
    container._sortable = Sortable.create(container, {
        handle: '.drag-handle',
        animation: 150,
        ghostClass: 'sortable-ghost',
        chosenClass: 'sortable-chosen',
        dragClass: 'sortable-drag',
        
        onStart: function(evt) {
            
            document.body.style.cursor = 'grabbing';
            
            //  Ë®òÈåÑÁï∂ÂâçÊäòÁñäÁãÄÊÖã
            savedStates = getCurrentCollapseStates();
            
        },
        
        onEnd: function(evt) {
            
            document.body.style.cursor = '';
            
            if (evt.oldIndex !== evt.newIndex) {
                // Êõ¥Êñ∞Ë≥áÊñôÈ†ÜÂ∫è
                reorderCreatorEvents(characterId, versionId, evt.oldIndex, evt.newIndex);
                
                //  Á´ãÂç≥ÊÅ¢Âæ©ÊäòÁñäÁãÄÊÖã
                setTimeout(() => {
                    restoreCollapseStates(savedStates);
                    
                }, 10);
            }
        }
    });
    
    
}
// ÈáçÊñ∞ÊéíÂ∫èÂâµ‰ΩúËÄÖ‰∫ã‰ª∂
function reorderCreatorEvents(characterId, versionId, oldIndex, newIndex) {
    const character = loveyDoveyCharacters.find(c => c.id === characterId);
    if (!character) return;
    
    const version = character.versions.find(v => v.id === versionId);
    if (!version || !version.creatorEvents) return;
    
    // Âü∑Ë°åÈô£ÂàóÈáçÊéí
    const movedEvent = version.creatorEvents.splice(oldIndex, 1)[0];
    version.creatorEvents.splice(newIndex, 0, movedEvent);
    
    // Êõ¥Êñ∞ÊôÇÈñìÊà≥Ë®ò
    TimestampManager.updateVersionTimestamp('loveydovey', characterId, versionId);
    markAsChanged();
    
    
    
    // Êõ¥Êñ∞Á∑®ËôüÔºå‰∏çÈáçÊñ∞Ê∏≤Êüì
    updateCreatorEventNumbers(version, versionId);
}

// Âè™Êõ¥Êñ∞Ââµ‰ΩúËÄÖ‰∫ã‰ª∂ÁöÑÁ∑®ËôüÈ°ØÁ§∫ÔºàÊîØÊè¥Â∞çÊØîÊ®°ÂºèÔºâ
function updateCreatorEventNumbers(version, versionId = null) {
    if (!version.creatorEvents) return;
    
    // Â¶ÇÊûúÊúâ versionIdÔºåÂÖàÊâæÂà∞Â∞çÊáâÁöÑÁâàÊú¨ÂÆπÂô®
    let searchContainer = document;
    if (versionId) {
        const versionContainer = document.querySelector(`#creator-events-list-${versionId}`)?.closest('.version-content');
        if (versionContainer) {
            searchContainer = versionContainer;
        }
    }
    
    version.creatorEvents.forEach((event, index) => {
        // Âú®ÊåáÂÆöÂÆπÂô®ÂÖßÊü•ÊâæÂÖÉÁ¥†
        const titleExpanded = searchContainer.querySelector(`#title-expanded-${event.id}`);
        if (titleExpanded) {
            const h4 = titleExpanded.querySelector('h4');
            if (h4) {
                const secretIcon = h4.querySelector('svg');
                const secretHtml = secretIcon ? secretIcon.outerHTML : '';
                h4.innerHTML = `Ââµ‰ΩúËÄÖ‰∫ã‰ª∂ ${index + 1} ${secretHtml}`;
            }
        }
    });
    
    
}


// Â≠òÂÑ≤ÈôÑÂä†Ë≥áË®äÊäòÁñäÁãÄÊÖã
let additionalInfoCollapseStates = {};

// ÂàáÊèõÈôÑÂä†Ë≥áË®äÁöÑÊäòÁñäÁãÄÊÖã
function toggleAdditionalInfoCollapse(infoId, event = null) {
    let content, titleExpanded, titleCollapsed;
    
    if (event) {
        // Êô∫ÊÖßÊü•ÊâæÔºöÂú®ÈªûÊìäÂÖÉÁ¥†ÁöÑÁâàÊú¨ÂÆπÂô®ÂÖßÊü•Êâæ
        const versionContainer = event.target.closest('.version-content');
        if (versionContainer) {
            content = versionContainer.querySelector(`#content-${infoId}`);
            titleExpanded = versionContainer.querySelector(`#title-expanded-${infoId}`);
            titleCollapsed = versionContainer.querySelector(`#title-collapsed-${infoId}`);
        }
    }
    
    // Â¶ÇÊûúÊô∫ÊÖßÊü•ÊâæÂ§±ÊïóÔºå‰ΩøÁî®ÂéüÈÇèËºØ
    if (!content) {
        content = document.getElementById(`content-${infoId}`);
        titleExpanded = document.getElementById(`title-expanded-${infoId}`);
        titleCollapsed = document.getElementById(`title-collapsed-${infoId}`);
    }
    
    if (!content || !titleExpanded || !titleCollapsed) return;
    
    const isCollapsed = content.style.display === 'none';
    
    if (isCollapsed) {
        // Â±ïÈñã
        content.style.display = 'block';
        titleExpanded.style.display = 'block';
        titleCollapsed.style.display = 'none';
    } else {
        // ÊäòÁñä
        content.style.display = 'none';
        titleExpanded.style.display = 'none';
        titleCollapsed.style.display = 'flex';
    }
    
    //  ‰øùÂ≠òÁãÄÊÖã
    saveCollapseStates();
}

// Êõ¥Êñ∞ÊäòÁñäÊôÇÁöÑÊ®ôÈ°åÈ°ØÁ§∫
function updateAdditionalInfoCollapsedTitle(infoId) {
    const titleCollapsed = document.getElementById(`title-collapsed-${infoId}`);
    if (!titleCollapsed) return;
    
    const container = document.querySelector(`[data-info-id="${infoId}"]`);
    if (!container) return;
    
    const title = container.querySelector('input[placeholder*="Ê®ôÈ°å"]')?.value || '';
    
    // Êõ¥Êñ∞Ê®ôÈ°åÈ°ØÁ§∫
    const titleElement = titleCollapsed.querySelector('div:first-child');
    if (titleElement) {
        // ÊâæÂà∞Áï∂ÂâçÈôÑÂä†Ë≥áË®äÁöÑÁ¥¢Âºï
        const allInfoItems = Array.from(document.querySelectorAll('.additional-info-item'));
        const currentIndex = allInfoItems.findIndex(item => item.dataset.infoId === infoId) + 1;
        
        titleElement.textContent = `${t('additionalInfo')} ${currentIndex} Ôºç ${title || t('noTitle')}`;

    }
}

//  Âè™Êõ¥Êñ∞ÈôÑÂä†Ë≥áË®äÁöÑÁ∑®ËôüÈ°ØÁ§∫ÔºàÊîØÊè¥Â∞çÊØîÊ®°ÂºèÔºâ
function updateAdditionalInfoNumbers(version, versionId = null) {
    if (!version.additionalInfo) return;
    
    //  Â¶ÇÊûúÊúâ versionIdÔºåÂÖàÊâæÂà∞Â∞çÊáâÁöÑÁâàÊú¨ÂÆπÂô®
    let searchContainer = document;
    if (versionId) {
        const versionContainer = document.querySelector(`#additional-info-list-${versionId}`)?.closest('.version-content');
        if (versionContainer) {
            searchContainer = versionContainer;
        }
    }
    
    version.additionalInfo.forEach((info, index) => {
        //  Âú®ÊåáÂÆöÂÆπÂô®ÂÖßÊü•ÊâæÂÖÉÁ¥†
        const titleExpanded = searchContainer.querySelector(`#title-expanded-${info.id}`);
        if (titleExpanded) {
            const h4 = titleExpanded.querySelector('h4');
            if (h4) {
                h4.textContent = `ÈôÑÂä†Ë≥áË®ä ${index + 1}`;
            }
        }
        
        // Êõ¥Êñ∞ÊäòÁñäÁãÄÊÖãÁöÑÁ∑®Ëôü
        const titleCollapsed = searchContainer.querySelector(`#title-collapsed-${info.id}`);
        if (titleCollapsed) {
            const titleDiv = titleCollapsed.querySelector('div:first-child');
            if (titleDiv) {
                const currentTitle = titleDiv.textContent.split('Ôºç')[1] || 'ÔºàÁÑ°Ê®ôÈ°åÔºâ';
                titleDiv.textContent = `ÈôÑÂä†Ë≥áË®ä ${index + 1} Ôºç ${currentTitle}`;
            }
        }
    });
    
}


// ===== ÊäòÁñäÁãÄÊÖãÁÆ°ÁêÜ =====
function saveCollapseStates() {
    try {
        //  ÂÖàËÆÄÂèñÁèæÊúâÁöÑÁãÄÊÖã
        const existingStates = loadCollapseStates();
        
        //  Âêà‰ΩµÁ≠ñÁï•Ôºö‰øùÁïôÁèæÊúâÁãÄÊÖãÔºåÂè™Êõ¥Êñ∞Áï∂ÂâçÈ†ÅÈù¢ÁöÑÁãÄÊÖã
        const newStates = {
            additionalInfo: { ...existingStates.additionalInfo, ...getCurrentAdditionalInfoCollapseStates() },
            creatorEvents: { ...existingStates.creatorEvents, ...getCurrentCreatorEventCollapseStates() },
            worldBookEntries: { ...existingStates.worldBookEntries, ...getCurrentWorldBookEntryCollapseStates() },
            timestamp: Date.now()
        };
        
        localStorage.setItem('loveydovey-collapse-states', JSON.stringify(newStates));
        
    } catch (error) {
        console.warn('‰øùÂ≠òÊäòÁñäÁãÄÊÖãÂ§±Êïó:', error);
    }
}

// ËºâÂÖ•ÊäòÁñäÁãÄÊÖã
function loadCollapseStates() {
    try {
        const saved = localStorage.getItem('loveydovey-collapse-states');
        if (saved) {
            const states = JSON.parse(saved);
            // Ê™¢Êü•ÊòØÂê¶ÁÇ∫Áï∂Êó•Êï∏ÊìöÔºàÈÅøÂÖçÈÅéÊúüÁãÄÊÖãÔºâ
            const oneDay = 24 * 60 * 60 * 1000;
            if (states.timestamp && (Date.now() - states.timestamp) < oneDay) {
                return states;
            }
        }
    } catch (error) {
        console.warn('ËºâÂÖ•ÊäòÁñäÁãÄÊÖãÂ§±Êïó:', error);
    }
    return { additionalInfo: {}, creatorEvents: {} };
}

// Áç≤ÂèñÁï∂ÂâçÈôÑÂä†Ë≥áË®äÊäòÁñäÁãÄÊÖã
function getCurrentAdditionalInfoCollapseStates() {
    const states = {};
    document.querySelectorAll('.additional-info-item').forEach(item => {
        const infoId = item.dataset.infoId;
        const content = document.getElementById(`content-${infoId}`);
        if (content) {
            states[infoId] = content.style.display === 'none';
        }
    });
    return states;
}

// Áç≤ÂèñÁï∂ÂâçÂâµ‰ΩúËÄÖ‰∫ã‰ª∂ÊäòÁñäÁãÄÊÖã  
function getCurrentCreatorEventCollapseStates() {
    const states = {};
    document.querySelectorAll('.creator-event-item').forEach(item => {
        const eventId = item.dataset.eventId;
        const content = document.getElementById(`content-${eventId}`);
        if (content) {
            states[eventId] = content.style.display === 'none';
        }
    });
    return states;
}

// ÊÅ¢Âæ©ÈôÑÂä†Ë≥áË®äÊäòÁñäÁãÄÊÖã
function restoreAdditionalInfoCollapseStates(states) {
    if (!states) return;
    
    Object.keys(states).forEach(infoId => {
        if (states[infoId]) {
            //  Êü•ÊâæÊâÄÊúâÂåπÈÖçÁöÑÂÖÉÁ¥†ÔºàÂ∞çÊØîÊ®°Âºè‰∏ãÂèØËÉΩÊúâÂ§öÂÄãÔºâ
            const allContentElements = document.querySelectorAll(`#content-${infoId}`);
            const allTitleExpanded = document.querySelectorAll(`#title-expanded-${infoId}`);
            const allTitleCollapsed = document.querySelectorAll(`#title-collapsed-${infoId}`);
            
            //  Â∞çÊØèÂÄãÂåπÈÖçÁöÑÂÖÉÁ¥†ÈÉΩÊáâÁî®ÊäòÁñäÁãÄÊÖã
            allContentElements.forEach(content => {
                if (content) content.style.display = 'none';
            });
            
            allTitleExpanded.forEach(titleExpanded => {
                if (titleExpanded) titleExpanded.style.display = 'none';
            });
            
            allTitleCollapsed.forEach(titleCollapsed => {
                if (titleCollapsed) titleCollapsed.style.display = 'flex';
            });
        }
    });
}

// ÊÅ¢Âæ©Ââµ‰ΩúËÄÖ‰∫ã‰ª∂ÊäòÁñäÁãÄÊÖã
function restoreCreatorEventCollapseStates(states) {
    if (!states) return;
    
    Object.keys(states).forEach(eventId => {
        if (states[eventId]) {
            //  Êü•ÊâæÊâÄÊúâÂåπÈÖçÁöÑÂÖÉÁ¥†ÔºàÂ∞çÊØîÊ®°Âºè‰∏ãÂèØËÉΩÊúâÂ§öÂÄãÔºâ
            const allContentElements = document.querySelectorAll(`#content-${eventId}`);
            const allTitleExpanded = document.querySelectorAll(`#title-expanded-${eventId}`);
            const allTitleCollapsed = document.querySelectorAll(`#title-collapsed-${eventId}`);
            
            //  Â∞çÊØèÂÄãÂåπÈÖçÁöÑÂÖÉÁ¥†ÈÉΩÊáâÁî®ÊäòÁñäÁãÄÊÖã
            allContentElements.forEach(content => {
                if (content) content.style.display = 'none';
            });
            
            allTitleExpanded.forEach(titleExpanded => {
                if (titleExpanded) titleExpanded.style.display = 'none';
            });
            
            allTitleCollapsed.forEach(titleCollapsed => {
                if (titleCollapsed) titleCollapsed.style.display = 'flex';
            });
        }
    });
}

// üîß Ê∑ªÂä†ÔºöÈôÑÂä†Ë≥áÊñôÂª∂ÈÅ≤ËºâÂÖ•ÂáΩÊï∏
function toggleAdditionalInfoCollapseLazy(characterId, versionId, infoId, index, event = null) {
    let content, titleExpanded, titleCollapsed;
    
    if (event) {
        const versionContainer = event.target.closest('.version-content');
        if (versionContainer) {
            content = versionContainer.querySelector(`#content-${infoId}`);
            titleExpanded = versionContainer.querySelector(`#title-expanded-${infoId}`);
            titleCollapsed = versionContainer.querySelector(`#title-collapsed-${infoId}`);
        }
    }
    
    if (!content) {
        content = document.getElementById(`content-${infoId}`);
        titleExpanded = document.getElementById(`title-expanded-${infoId}`);
        titleCollapsed = document.getElementById(`title-collapsed-${infoId}`);
    }
    
    if (!content || !titleExpanded || !titleCollapsed) return;
    
    const isExpanded = content.style.display !== 'none';
    
    if (isExpanded) {
        // Êë∫ÁñäÔºöÈö±ËóèÂÖßÂÆπ
    content.style.display = 'none';
    titleExpanded.style.display = 'none';
    titleCollapsed.style.display = 'flex'; 
    } else {
        // Â±ïÈñãÔºöÊ™¢Êü•ÊòØÂê¶ÈúÄË¶ÅËºâÂÖ•ÂÖßÂÆπ
        if (content.innerHTML.trim() === '' || content.innerHTML.includes('<!-- Content will be loaded lazily')) {
            // Á¨¨‰∏ÄÊ¨°Â±ïÈñãÔºåÈúÄË¶ÅËºâÂÖ•ÂÖßÂÆπ
            loadAdditionalInfoContent(characterId, versionId, infoId, index);
        }
        
        // È°ØÁ§∫ÂÖßÂÆπ
        content.style.display = 'block';
    titleExpanded.style.display = 'block';  
    titleCollapsed.style.display = 'none'; 
    }
}

// ËºâÂÖ•ÈôÑÂä†Ë≥áÊñôË©≥Á¥∞ÂÖßÂÆπ
function loadAdditionalInfoContent(characterId, versionId, infoId, index) {
    // ÊâæÂà∞Â∞çÊáâÁöÑÈôÑÂä†Ë≥áÊñô
    const character = loveyDoveyCharacters.find(c => c.id === characterId);
    if (!character) return;
    
    const version = character.versions.find(v => v.id === versionId);
    if (!version || !version.additionalInfo) return;
    
    const info = version.additionalInfo.find(i => i.id === infoId);
    if (!info) return;
    
    // ÁîüÊàêË©≥Á¥∞ÂÖßÂÆπHTML
    const detailHTML = generateAdditionalInfoDetailContent(characterId, versionId, info, index);
    
    // ÊèíÂÖ•Âà∞Â∞çÊáâÁöÑÂÖßÂÆπÂçÄÂüü
    const contentDiv = document.getElementById(`content-${infoId}`);
    if (contentDiv) {
        contentDiv.innerHTML = detailHTML;
        
        // ÈáçÊñ∞ÂàùÂßãÂåñÁõ∏ÈóúÂäüËÉΩ
setTimeout(() => {
    updateAllPageStats();
    initAutoResize();
    
    const container = document.getElementById(`content-${infoId}`);
    if (container) {
        const inputs = container.querySelectorAll('input, textarea');
        inputs.forEach(input => {
            if (input.id && input.oninput) {
                // Ëß∏Áôº‰∏ÄÊ¨° oninput ‰æÜÂàùÂßãÂåñÂ≠óÊï∏Áµ±Ë®à
                const event = new Event('input', { bubbles: true });
                input.dispatchEvent(event);
            }
        });
    }
    
    if (typeof ScrollbarManager !== 'undefined') {
        ScrollbarManager.initializeAll();
    }
}, 50);
    }
}

// ÁîüÊàêÈôÑÂä†Ë≥áÊñôË©≥Á¥∞ÂÖßÂÆπ
function generateAdditionalInfoDetailContent(characterId, versionId, info, index) {
    return `
        <!-- Ê®ôÈ°åÊ¨Ñ‰Ωç -->
        <div style="margin-bottom: 12px; margin-top: 16px;">
            <label style="display: block; margin-bottom: 4px; font-size: 0.85em; color: var(--text-color);">${t('additionalTitle')}</label>
            <input type="text" 
                   class="field-input" 
                   id="additionalTitle-${info.id}" 
                   placeholder="${t('additionalTitlePlaceholder')}"
                   style="width: 100%; ${(info.title || '').length > 30 ? 'border-color: #e74c3c; box-shadow: 0 0 0 2px rgba(231, 76, 60, 0.2);' : ''}"
                   value="${info.title || ''}"
                   oninput="updateLoveyDoveyFieldWithPath('loveydovey', '${characterId}', '${versionId}', 'additionalInfo.${index}.title', this.value, 30); updateAdditionalInfoCollapsedTitle('${info.id}')">
            <div class="char-count-display" data-target="additionalTitle-${info.id}" 
                 style="text-align: right; font-size: 0.75em; ${(info.title || '').length > 30 ? 'color: #e74c3c; font-weight: bold;' : 'color: var(--text-muted);'} margin-top: 4px;">
                ${(info.title || '').length}/30 ${t('chars')}
            </div>
        </div>

        <!-- ÂÖßÂÆπÊ¨Ñ‰Ωç -->
        <div style="margin-bottom: 12px;">
            <label style="display: block; margin-bottom: 4px; font-size: 0.85em; color: var(--text-color);">${t('additionalContent')}</label>
            <textarea class="field-input" 
                      id="additionalContent-${info.id}" 
                      placeholder="${t('additionalContentPlaceholder')}"
                      style="width: 100%; height: 100px; resize: vertical; ${(info.content || '').length > 500 ? 'border-color: #e74c3c; box-shadow: 0 0 0 2px rgba(231, 76, 60, 0.2);' : ''}"
                      oninput="updateLoveyDoveyFieldWithPath('loveydovey', '${characterId}', '${versionId}', 'additionalInfo.${index}.content', this.value, 500); autoResizeTextarea(this);"
                      onfocus="showAdditionalFullscreenBtn(this);"
                      onblur="hideAdditionalFullscreenBtn(this);">${info.content || ''}</textarea>
            
            <!-- Â∫ïÈÉ®Â∑•ÂÖ∑ÂàóÔºöÂÖ®Ëû¢ÂπïÊåâÈàï + Â≠óÊï∏Áµ±Ë®à -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 6px;">
                <button class="fullscreen-btn-base fullscreen-btn-toolbar" 
                        onclick="openFullscreenEditor('additionalContent-${info.id}', '${t('additionalInfo')} ${index + 1}')"
                        title="${t('fullscreenEdit')}">
                    ‚õ∂
                </button>
                
                <div class="char-count-display" data-target="additionalContent-${info.id}" 
                     style="font-size: 0.75em; ${(info.content || '').length > 500 ? 'color: #e74c3c; font-weight: bold;' : 'color: var(--text-muted);'}">
                    ${(info.content || '').length}/500 ${t('chars')}
                </div>
            </div>
        </div>
    `;
}

// üîß Ê∑ªÂä†ÔºöÂâµ‰ΩúËÄÖ‰∫ã‰ª∂Âª∂ÈÅ≤ËºâÂÖ•ÂáΩÊï∏
function toggleCreatorEventCollapseLazy(characterId, versionId, eventId, index, event = null) {
    let content, titleExpanded, titleCollapsed;
    
    if (event) {
        const versionContainer = event.target.closest('.version-content');
        if (versionContainer) {
            content = versionContainer.querySelector(`#content-${eventId}`);
            titleExpanded = versionContainer.querySelector(`#title-expanded-${eventId}`);
            titleCollapsed = versionContainer.querySelector(`#title-collapsed-${eventId}`);
        }
    }
    
    if (!content) {
        content = document.getElementById(`content-${eventId}`);
        titleExpanded = document.getElementById(`title-expanded-${eventId}`);
        titleCollapsed = document.getElementById(`title-collapsed-${eventId}`);
    }
    
    if (!content || !titleExpanded || !titleCollapsed) return;
    
    const isExpanded = content.style.display !== 'none';
    
    if (isExpanded) {
        // Êë∫ÁñäÔºöÈö±ËóèÂÖßÂÆπ
        content.style.display = 'none';
        titleExpanded.style.display = 'none';
        titleCollapsed.style.display = 'flex';
    } else {
        // Â±ïÈñãÔºöÊ™¢Êü•ÊòØÂê¶ÈúÄË¶ÅËºâÂÖ•ÂÖßÂÆπ
        if (content.innerHTML.trim() === '' || content.innerHTML.includes('<!-- Content will be loaded lazily')) {
            // Á¨¨‰∏ÄÊ¨°Â±ïÈñãÔºåÈúÄË¶ÅËºâÂÖ•ÂÖßÂÆπ
            loadCreatorEventContent(characterId, versionId, eventId, index);
        }
        
        // È°ØÁ§∫ÂÖßÂÆπ
        content.style.display = 'block';
        titleExpanded.style.display = 'block';
        titleCollapsed.style.display = 'none';
    }
}

// ËºâÂÖ•Ââµ‰ΩúËÄÖ‰∫ã‰ª∂Ë©≥Á¥∞ÂÖßÂÆπ
function loadCreatorEventContent(characterId, versionId, eventId, index) {
    const character = loveyDoveyCharacters.find(c => c.id === characterId);
    if (!character) return;
    
    const version = character.versions.find(v => v.id === versionId);
    if (!version || !version.creatorEvents) return;
    
    const event = version.creatorEvents.find(e => e.id === eventId);
    if (!event) return;
    
    // ÁîüÊàêË©≥Á¥∞ÂÖßÂÆπHTML
    const detailHTML = generateCreatorEventDetailContent(characterId, versionId, event, index);
    
    // ÊèíÂÖ•Âà∞Â∞çÊáâÁöÑÂÖßÂÆπÂçÄÂüü
    const contentDiv = document.getElementById(`content-${eventId}`);
    if (contentDiv) {
        contentDiv.innerHTML = detailHTML;
        
        // ÈáçÊñ∞ÂàùÂßãÂåñÁõ∏ÈóúÂäüËÉΩ
setTimeout(() => {
    updateAllPageStats();
    initAutoResize();
    
    const container = document.getElementById(`content-${eventId}`);
    if (container) {
        const inputs = container.querySelectorAll('input, textarea');
        inputs.forEach(input => {
            if (input.id && input.oninput) {
                // Ëß∏Áôº‰∏ÄÊ¨° oninput ‰æÜÂàùÂßãÂåñÂ≠óÊï∏Áµ±Ë®à
                const event = new Event('input', { bubbles: true });
                input.dispatchEvent(event);
            }
        });
    }
    
    if (typeof ScrollbarManager !== 'undefined') {
        ScrollbarManager.initializeAll();
    }
}, 50);
    }
}

// ÁîüÊàêÂâµ‰ΩúËÄÖ‰∫ã‰ª∂Ë©≥Á¥∞ÂÖßÂÆπ
function generateCreatorEventDetailContent(characterId, versionId, event, index) {
    return `
        <!-- ÊôÇÈñìÂú∞ÈªûÊ¨Ñ‰Ωç -->
        <div style="margin-bottom: 0px;">
            <label style="display: block; margin-bottom: 4px; margin-top: 5px; font-size: 0.85em; color: var(--text-color);">${t('timeAndPlace')}</label>
            <input type="text" 
                   class="field-input" 
                   id="eventTimeAndPlace-${event.id}"
                   placeholder="${t('timeAndPlacePlaceholder')}"
                   style="width: 100%; ${(event.timeAndPlace || '').length > 30 ? 'border-color: #e74c3c; box-shadow: 0 0 0 2px rgba(231, 76, 60, 0.2);' : ''}"
                   value="${event.timeAndPlace || ''}"
                   oninput="updateLoveyDoveyFieldWithPath('loveydovey', '${characterId}', '${versionId}', 'creatorEvents.${index}.timeAndPlace', this.value, 30); updateEventCollapsedTitle('${event.id}')">
            <div class="char-count-display" data-target="eventTimeAndPlace-${event.id}" 
                 style="text-align: right; font-size: 0.75em; ${(event.timeAndPlace || '').length > 30 ? 'color: #e74c3c; font-weight: bold;' : 'color: var(--text-muted);'} margin-top: 4px;">
                ${(event.timeAndPlace || '').length} / 30 ${t('chars')}
            </div>
        </div>

        <!-- Ê®ôÈ°åÊ¨Ñ‰Ωç -->
        <div style="margin-bottom: 0px;">
            <label style="display: block; margin-bottom: 4px; font-size: 0.85em; color: var(--text-color);">${t('additionalContent')}</label>
            <input type="text" 
                   class="field-input" 
                   id="eventTitle-${event.id}"
                   placeholder="${t('eventTitlePlaceholder')}"
                   style="width: 100%; ${(event.title || '').length > 30 ? 'border-color: #e74c3c; box-shadow: 0 0 0 2px rgba(231, 76, 60, 0.2);' : ''}"
                   value="${event.title || ''}"
                   oninput="updateLoveyDoveyFieldWithPath('loveydovey', '${characterId}', '${versionId}', 'creatorEvents.${index}.title', this.value, 30); updateEventCollapsedTitle('${event.id}')">
            <div class="char-count-display" data-target="eventTitle-${event.id}" 
                 style="text-align: right; font-size: 0.75em; ${(event.title || '').length > 30 ? 'color: #e74c3c; font-weight: bold;' : 'color: var(--text-muted);'} margin-top: 4px;">
                ${(event.title || '').length} / 30 ${t('chars')}
            </div>
        </div>

        <!-- ÂÖßÂÆπÊ¨Ñ‰Ωç -->
        <div style="margin-bottom: 0px;">
            <label style="display: block; margin-bottom: 4px; font-size: 0.85em; color: var(--text-color);">${t('additionalContent')}</label>
            <textarea class="field-input" 
                      id="eventContent-${event.id}"
                      placeholder="${t('eventContentPlaceholder')}"
                      style="width: 100%; height: 120px; resize: vertical; ${(event.content || '').length > 2000 ? 'border-color: #e74c3c; box-shadow: 0 0 0 2px rgba(231, 76, 60, 0.2);' : ''}"
                      oninput="updateLoveyDoveyFieldWithPath('loveydovey', '${characterId}', '${versionId}', 'creatorEvents.${index}.content', this.value, 2000); autoResizeTextarea(this);"
                      onfocus="showAdditionalFullscreenBtn(this);"
                      onblur="hideAdditionalFullscreenBtn(this);">${event.content || ''}</textarea>
            
            <!-- Â∫ïÈÉ®Â∑•ÂÖ∑ÂàóÔºöÂÖ®Ëû¢ÂπïÊåâÈàï + Â≠óÊï∏Áµ±Ë®à -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 6px;">
                <button class="fullscreen-btn-base fullscreen-btn-toolbar" 
                        onclick="openFullscreenEditor('eventContent-${event.id}', 'Creator Event Content')" 
                        title="${t('fullscreenEdit')}">
                    ‚õ∂
                </button>
                
                <div class="char-count-display" data-target="eventContent-${event.id}" 
                     style="font-size: 0.75em; ${(event.content || '').length > 2000 ? 'color: #e74c3c; font-weight: bold;' : 'color: var(--text-muted);'}">
                    ${(event.content || '').length} / 2000 ${t('chars')}
                </div>
            </div>
        </div>

        <!-- ÁßòÂØÜË®≠ÁΩÆÊ¨Ñ‰Ωç -->
        <div style="margin-top: 16px; padding-top: 12px; border-top: 1px solid var(--border-color);">
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 0.9em;">
                <input type="checkbox" 
                    ${event.isSecret ? 'checked' : ''}
                    onchange="toggleCreatorEventSecret('${characterId}', '${versionId}', '${event.id}')"
                    style="margin: 0;">
                <span style="color: var(--text-color); display: flex; align-items: center; gap: 6px;">
                    ${t('secretNarrativeSetting')}
                    ${event.isSecret ? IconManager.lock({width: 14, height: 14}) : ''}
                </span>
            </label>
        </div>
    `;
}